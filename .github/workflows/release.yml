name: Release Bisq 2

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-release:
    name: Build ${{ matrix.name }} (${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x64
          - os: ubuntu-24.04
            name: Linux x64
            arch: x64
            type: linux
            appimage: true
          
          # Linux ARM64
          - os: ubuntu-24.04-arm
            name: Linux ARM64
            arch: arm64
            type: linux
            appimage: true
          
          # macOS Intel (x64)
          - os: macos-13
            name: macOS Intel
            arch: x64
            type: macos
          
          # macOS Apple Silicon (arm64)
          - os: macos-15
            name: macOS Apple Silicon
            arch: arm64
            type: macos
          
          # Windows x64
          - os: windows-latest
            name: Windows x64
            arch: x64
            type: windows
          
          # Windows ARM64
          - os: windows-11-arm
            name: Windows ARM64
            arch: arm64
            type: windows

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Java JDK
        uses: actions/setup-java@v5.2.0
        with:
          java-version: '21'
          distribution: 'zulu'

      - name: Build with Gradle
        run: ./gradlew build -x test

      - name: Create Distribution
        run: ./gradlew apps:desktop:desktop-app-launcher:installDist

      # Linux Packaging (deb, rpm, AppImage)
      - name: Package Native (Linux)
        if: matrix.type == 'linux'
        run: |
          ./gradlew apps:desktop:desktop-app-launcher:generateInstallers
          # Renommer les packages avec architecture
          for f in apps/desktop/desktop-app-launcher/build/packaging/jpackage/packages/*.deb; do
            mv "$f" "apps/desktop/desktop-app-launcher/build/packaging/jpackage/packages/bisq2-${{ github.ref_name }}-linux-${{ matrix.arch }}.deb" 2>/dev/null || true
          done
          for f in apps/desktop/desktop-app-launcher/build/packaging/jpackage/packages/*.rpm; do
            mv "$f" "apps/desktop/desktop-app-launcher/build/packaging/jpackage/packages/bisq2-${{ github.ref_name }}-linux-${{ matrix.arch }}.rpm" 2>/dev/null || true
          done

      # AppImage Creation
      - name: Create AppImage (Linux)
        if: matrix.type == 'linux' && matrix.appimage == true
        run: |
          # Installer appimagetool
          sudo apt-get update && sudo apt-get install -y libfuse2
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage -O appimagetool
          chmod +x appimagetool
          
          # Préparer l'AppDir
          mkdir -p Bisq2.AppDir/usr/bin
          cp -r apps/desktop/desktop-app-launcher/build/install/desktop-app-launcher/* Bisq2.AppDir/usr/bin/
          
          # Créer le fichier desktop
          cat > Bisq2.AppDir/bisq2.desktop << 'EOF'
          [Desktop Entry]
          Name=Bisq 2
          Exec=bisq2
          Icon=bisq2
          Type=Application
          Categories=Office;Finance;
          EOF
          
          # Copier l'icône (si disponible)
          find . -name "*.png" -path "*/desktop-app-launcher/*" | head -1 | xargs -I {} cp {} Bisq2.AppDir/bisq2.png || true
          
          # Créer l'AppImage
          ARCH=${{ matrix.arch == 'arm64' && 'aarch64' || 'x86_64' }} ./appimagetool Bisq2.AppDir \
            "apps/desktop/desktop-app-launcher/build/packaging/jpackage/packages/bisq2-${{ github.ref_name }}-linux-${{ matrix.arch }}.AppImage"

      # macOS Packaging
      - name: Package Native (macOS)
        if: matrix.type == 'macos'
        run: |
          ./gradlew apps:desktop:desktop-app-launcher:generateInstallers
          mv apps/desktop/desktop-app-launcher/build/packaging/jpackage/packages/*.dmg \
             "apps/desktop/desktop-app-launcher/build/packaging/jpackage/packages/bisq2-${{ github.ref_name }}-macos-${{ matrix.arch }}.dmg" || true

      # Windows Packaging
      - name: Package Native (Windows)
        if: matrix.type == 'windows'
        run: |
          ./gradlew apps:desktop:desktop-app-launcher:generateInstallers
        shell: cmd

      - name: Rename Windows Artifact
        if: matrix.type == 'windows'
        run: |
          $files = Get-ChildItem -Path "apps/desktop/desktop-app-launcher/build/packaging/jpackage/packages" -Filter "*.exe"
          foreach ($file in $files) {
            $newName = "bisq2-${{ github.ref_name }}-windows-${{ matrix.arch }}.exe"
            Rename-Item -Path $file.FullName -NewName $newName
          }
          $files = Get-ChildItem -Path "apps/desktop/desktop-app-launcher/build/packaging/jpackage/packages" -Filter "*.msi"
          foreach ($file in $files) {
            $newName = "bisq2-${{ github.ref_name }}-windows-${{ matrix.arch }}.msi"
            Rename-Item -Path $file.FullName -NewName $newName
          }
        shell: pwsh

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: bisq2-${{ matrix.name }}-${{ matrix.arch }}
          path: |
            apps/desktop/desktop-app-launcher/build/packaging/jpackage/packages/*.deb
            apps/desktop/desktop-app-launcher/build/packaging/jpackage/packages/*.rpm
            apps/desktop/desktop-app-launcher/build/packaging/jpackage/packages/*.AppImage
            apps/desktop/desktop-app-launcher/build/packaging/jpackage/packages/*.dmg
            apps/desktop/desktop-app-launcher/build/packaging/jpackage/packages/*.exe
            apps/desktop/desktop-app-launcher/build/packaging/jpackage/packages/*.msi
          if-no-files-found: ignore

  create-release:
    name: Create GitHub Release
    needs: build-release
    runs-on: ubuntu-latest
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: List Artifacts
        run: ls -la artifacts/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/*
          draft: true
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
